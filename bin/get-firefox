#! /usr/bin/env node

var index = require("../");
var program = require("commander");
var path = require('path');
var pkg = require( path.join(__dirname, "../", 'package.json') );
var colors = require("colors");

program
    .version(pkg.version)
    .option("-p --platform <platform>", "platform of the Firefox version", /^(win|mac|linux|android|linux-add-on-devel)$/i, 'linux')
    .option("-a --architecture [arch]", "platform architecture", /^(x86(_64)?|multi|arm-v15)$/)
    .option("-t --target [target]", "target filename, defaults to the remote filename")
    .option("-c --check", "check the checksum for the download")
    .option("-e --extract", "extract archive after download")
    .option("-l --list", "list all platforms and architectures")
    .option("-b --branch [branch]", "release branch to fetch", /^(unbranded-)?(nightly|aurora|beta|release|esr)$/, 'nightly')
    .parse(process.argv);

if(program.list) {
    var platforms = require("../lib/platforms.json");
    var branch, plat, title;
    for(var p in platforms) {
        plat = platforms[p];
        process.stdout.write(p.underline.bold + "\n");
        for(var b in plat.branches) {
            branch = plat.branches[b];
            title = b.bold;
            if(b == plat.defaultBranch) {
                title = title.yellow;
                title += " (default)".grey;
            }
            process.stdout.write(" " + title + "\n");
            for(var a in branch.arches) {
                title = a;
                if(a == branch.defaultArch) {
                    title += " (default)".grey;
                }
                process.stdout.write("   - " + title + "\n");
            }
        }
        process.stdout.write("\n");
    }
}
else {
    process.stdout.write("Searching latest Firefox...\n");
    var progress;

    var container = index.getContainer(program.branch, program.platform, program.arch);

    var promise = Promise.resolve(program.target);
    if(!program.target) {
        promise = container.getFileName();
    }
    return Promise.all([
        promise,
        container.getFileURL()
    ]).then((urls) => {
        process.stdout.write("Downloading from "+ urls[1].blue + " and saving as " + urls[0].blue + "\n");
        return index.downloadFirefox(container, urls[0]).then(() => {
            if(program.check) {
                return index.check(container, urls[0]).then(function(msg) {
                    process.stdout.write(msg+"\n");
                });
            }
        }).then(() => {
            if(program.extract) {
                process.stdout.write("Extracting the archive...\n");
                return index.extract(urls[0]);
            }
        });
    })
    .catch((error) => {
        process.stderr.write("Error downloading Firefox: "+error.toString().red+"\n");
    });
}
